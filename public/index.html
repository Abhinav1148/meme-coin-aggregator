<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meme Coin Aggregator - Real-time Dashboard</title>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .status.connected {
            background: #10b981;
            color: white;
        }
        
        .status.disconnected {
            background: #ef4444;
            color: white;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .control-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        select, input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        select {
            min-width: 150px;
        }
        
        input[type="number"] {
            width: 100px;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        button:hover {
            background: #5568d3;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        
        .pagination-info {
            color: #666;
            font-size: 14px;
        }
        
        .tokens-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .token-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        
        .token-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .token-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .token-name {
            font-weight: bold;
            font-size: 18px;
            color: #333;
        }
        
        .token-ticker {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        
        .token-price {
            font-size: 24px;
            font-weight: bold;
            color: #10b981;
            margin-bottom: 10px;
        }
        
        .token-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 14px;
        }
        
        .info-item {
            color: #666;
        }
        
        .info-value {
            font-weight: bold;
            color: #333;
        }
        
        .price-change {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
            margin-top: 10px;
        }
        
        .price-change.positive {
            background: #d1fae5;
            color: #065f46;
        }
        
        .price-change.negative {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .log {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .log-entry {
            margin-bottom: 5px;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            flex: 1;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .update-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            margin-left: 5px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Meme Coin Aggregator - Real-time Dashboard</h1>
            <div id="status" class="status disconnected">Disconnected</div>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-label">Tokens Displayed</div>
                    <div class="stat-value" id="tokenCount">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Updates Received</div>
                    <div class="stat-value" id="updateCount">0<span class="update-indicator" id="updateIndicator" style="display: none;"></span></div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Last Update</div>
                    <div class="stat-value" id="lastUpdate" style="font-size: 14px;">Never</div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button id="connectBtn" onclick="connect()">Connect</button>
                <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
                <button onclick="clearLogs()">Clear Logs</button>
            </div>
            
            <div class="control-group">
                <label>Time Period Filter</label>
                <div class="control-row">
                    <select id="timePeriod">
                        <option value="">All Periods</option>
                        <option value="1h">1 Hour</option>
                        <option value="24h">24 Hours</option>
                        <option value="7d">7 Days</option>
                    </select>
                </div>
            </div>
            
            <div class="control-group">
                <label>Sort By</label>
                <div class="control-row">
                    <select id="sortField">
                        <option value="volume">Volume</option>
                        <option value="price_change">Price Change</option>
                        <option value="market_cap">Market Cap</option>
                        <option value="liquidity">Liquidity</option>
                        <option value="transaction_count">Transaction Count</option>
                    </select>
                    <select id="sortOrder">
                        <option value="desc">Descending</option>
                        <option value="asc">Ascending</option>
                    </select>
                </div>
            </div>
            
            <div class="control-group">
                <label>Pagination</label>
                <div class="control-row">
                    <label style="display: inline; margin-right: 5px;">Tokens per page:</label>
                    <input type="number" id="pageSize" min="20" max="30" value="25">
                    <button onclick="applyFilters()">Apply Filters</button>
                </div>
            </div>
        </div>
        
        <div class="pagination">
            <button id="prevBtn" onclick="previousPage()" disabled>‚Üê Previous</button>
            <span class="pagination-info" id="pageInfo">Page 1</span>
            <button id="nextBtn" onclick="nextPage()" disabled>Next ‚Üí</button>
        </div>
        
        <div id="tokens" class="tokens-grid"></div>
        
        <div class="log" id="log"></div>
    </div>
    
    <script>
        let socket = null;
        let tokenCount = 0;
        let updateCount = 0;
        let currentPage = 0;
        let pageSize = 25;
        let allTokens = [];
        const tokensMap = new Map();
        
        const API_URL = window.location.origin;
        
        // Current preferences
        let currentPreferences = {
            filter: {},
            sort: { field: 'volume', order: 'desc' },
            pagination: { limit: 25, cursor: '0' }
        };
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLogs() {
            document.getElementById('log').innerHTML = '';
        }
        
        function updateStatus(connected) {
            const statusDiv = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const indicator = document.getElementById('updateIndicator');
            
            if (connected) {
                statusDiv.textContent = 'Connected';
                statusDiv.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                indicator.style.display = 'inline-block';
            } else {
                statusDiv.textContent = 'Disconnected';
                statusDiv.className = 'status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                indicator.style.display = 'none';
            }
        }
        
        function applyFilters() {
            if (!socket || !socket.connected) {
                log('‚ö†Ô∏è Please connect first', 'error');
                return;
            }
            
            // Get filter values
            const timePeriod = document.getElementById('timePeriod').value;
            const sortField = document.getElementById('sortField').value;
            const sortOrder = document.getElementById('sortOrder').value;
            pageSize = parseInt(document.getElementById('pageSize').value) || 25;
            
            // Update preferences
            currentPreferences = {
                filter: timePeriod ? { timePeriod } : {},
                sort: { field: sortField, order: sortOrder },
                pagination: { limit: pageSize, cursor: '0' }
            };
            
            currentPage = 0;
            
            // Send preferences to server via WebSocket
            socket.emit('updatePreferences', currentPreferences);
            log(`üîç Applied filters: ${timePeriod || 'All'} | Sort: ${sortField} ${sortOrder} | Page size: ${pageSize}`);
        }
        
        function previousPage() {
            if (currentPage > 0) {
                currentPage--;
                updatePagination();
                socket.emit('updatePreferences', {
                    ...currentPreferences,
                    pagination: { limit: pageSize, cursor: (currentPage * pageSize).toString() }
                });
            }
        }
        
        function nextPage() {
            if (allTokens.length >= (currentPage + 1) * pageSize) {
                currentPage++;
                updatePagination();
                socket.emit('updatePreferences', {
                    ...currentPreferences,
                    pagination: { limit: pageSize, cursor: (currentPage * pageSize).toString() }
                });
            }
        }
        
        function updatePagination() {
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            pageInfo.textContent = `Page ${currentPage + 1}`;
            prevBtn.disabled = currentPage === 0;
            nextBtn.disabled = allTokens.length < (currentPage + 1) * pageSize;
        }
        
        function connect() {
            if (socket) {
                socket.disconnect();
            }
            
            log('Connecting to WebSocket server...');
            socket = io(API_URL);
            
            socket.on('connect', () => {
                log('‚úÖ Connected to WebSocket server', 'success');
                updateStatus(true);
                
                // Get initial preferences
                const timePeriod = document.getElementById('timePeriod').value;
                const sortField = document.getElementById('sortField').value;
                const sortOrder = document.getElementById('sortOrder').value;
                pageSize = parseInt(document.getElementById('pageSize').value) || 25;
                
                currentPreferences = {
                    filter: timePeriod ? { timePeriod } : {},
                    sort: { field: sortField, order: sortOrder },
                    pagination: { limit: pageSize, cursor: '0' }
                };
                
                // Subscribe with preferences
                socket.emit('subscribe', currentPreferences);
            });
            
            socket.on('disconnect', () => {
                log('‚ùå Disconnected from WebSocket server', 'error');
                updateStatus(false);
            });
            
            socket.on('subscribed', (data) => {
                log(`‚úÖ ${data.message}`, 'success');
            });
            
            socket.on('tokens:update', (data) => {
                updateCount++;
                document.getElementById('updateCount').textContent = updateCount;
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                
                log(`üìä Received ${data.tokens.length} token updates (${data.type || 'full'})`);
                
                // Store all tokens
                allTokens = data.tokens;
                
                // Update tokens map for rendering
                data.tokens.forEach(token => {
                    tokensMap.set(token.token_address, token);
                });
                
                renderTokens();
                updatePagination();
            });
            
            socket.on('error', (error) => {
                log(`‚ùå Error: ${error.message}`, 'error');
            });
        }
        
        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
                log('Disconnected from WebSocket server');
                updateStatus(false);
            }
        }
        
        function renderTokens() {
            const tokensDiv = document.getElementById('tokens');
            tokensDiv.innerHTML = '';
            
            // Get tokens for current page
            const startIdx = currentPage * pageSize;
            const endIdx = startIdx + pageSize;
            const tokensToShow = allTokens.slice(startIdx, endIdx);
            
            tokenCount = tokensToShow.length;
            document.getElementById('tokenCount').textContent = tokenCount;
            
            if (tokensToShow.length === 0) {
                tokensDiv.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">No tokens to display</div>';
                return;
            }
            
            tokensToShow.forEach(token => {
                const card = document.createElement('div');
                card.className = 'token-card';
                
                // Determine which price change to show based on filter
                const timePeriod = document.getElementById('timePeriod').value;
                let priceChange = 0;
                if (timePeriod === '1h' && token.price_1hr_change !== undefined) {
                    priceChange = token.price_1hr_change;
                } else if (timePeriod === '7d' && token.price_7d_change !== undefined) {
                    priceChange = token.price_7d_change;
                } else {
                    priceChange = token.price_24hr_change || token.price_1hr_change || 0;
                }
                
                const changeClass = priceChange >= 0 ? 'positive' : 'negative';
                const changeSign = priceChange >= 0 ? '+' : '';
                
                card.innerHTML = `
                    <div class="token-header">
                        <div class="token-name">${token.token_name}</div>
                        <div class="token-ticker">${token.token_ticker}</div>
                    </div>
                    <div class="token-price">${token.price_sol.toExponential(4)} SOL</div>
                    <div class="token-info">
                        <div class="info-item">Volume:</div>
                        <div class="info-value">${token.volume_sol.toFixed(2)} SOL</div>
                        <div class="info-item">Liquidity:</div>
                        <div class="info-value">${token.liquidity_sol.toFixed(2)} SOL</div>
                        <div class="info-item">Market Cap:</div>
                        <div class="info-value">${token.market_cap_sol.toFixed(2)} SOL</div>
                        <div class="info-item">Protocol:</div>
                        <div class="info-value">${token.protocol}</div>
                    </div>
                    <div class="price-change ${changeClass}">
                        ${changeSign}${priceChange.toFixed(2)}%
                    </div>
                `;
                
                tokensDiv.appendChild(card);
            });
        }
        
        // Auto-connect on load
        window.addEventListener('load', () => {
            log('Page loaded. Click Connect to start receiving real-time updates.');
            log('üí° Tip: All updates come through WebSocket - no HTTP calls after initial connection!');
        });
    </script>
</body>
</html>
